<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Settings</title>
  <!-- Default stylesheet, will be changed by JS -->
  <link id="theme-stylesheet" rel="stylesheet" href="light.css">
</head>
<body>
  <div class="title-bar">
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back</button>
    <span class="title-text">Settings</span>
    <!-- The nav-buttons div keeps the back button aligned left -->
    <div class="nav-buttons"></div>
  </div>

  <!-- The form is now the main styled container on this page -->
  <form id="settingsForm">
    <div class="setting-group">
      <h3>Theme</h3>
      <div class="radio-group">
        <input type="radio" id="light" name="theme" value="light" checked>
        <label for="light">Light</label>
        <input type="radio" id="dark" name="theme" value="dark">
        <label for="dark">Dark</label>
      </div>
    </div>

    <div class="setting-group">
      <h3>Search</h3>
      <label for="suggestions_count">Suggestions to show:</label>
      <input type="number" id="suggestions_count" name="suggestions_count" min="1" max="20" value="10">
    </div>
    
    <button type="submit">Save Settings</button>
      <div id="message"></div>
  </form>


  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('settingsForm');
        const messageDiv = document.getElementById('message');
        const themeStylesheet = document.getElementById('theme-stylesheet');
        const username = sessionStorage.getItem('currentUser') || 'guest';

        function applyTheme(themeName) {
            themeStylesheet.href = `${themeName}.css`;
        }

        if (username !== 'guest') {
            fetch(`/cgi-bin/search.cgi?get_settings=1&user=${username}`)
              .then(res => res.json())
              .then(settings => {
                if (settings) {
                    document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
                    document.getElementById('suggestions_count').value = settings.suggestions_count;
                    applyTheme(settings.theme);
                }
              })
              .catch(err => console.error("Failed to load settings:", err));
        }

        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const settingsData = {
              theme: formData.get('theme'),
              suggestions_count: formData.get('suggestions_count')
          };

          fetch(`/cgi-bin/search.cgi?save_settings=1&user=${username}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settingsData)
          })
          .then(res => res.text())
          .then(text => {
            messageDiv.textContent = text;
            messageDiv.className = 'visible';
            applyTheme(settingsData.theme);
            setTimeout(() => { messageDiv.className = ''; }, 3000);
          })
          .catch(err => console.error("Failed to save settings:", err));
        });
    });
  </script>
</body>
</html>
